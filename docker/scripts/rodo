#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd)"

sfm-cpu() {
    local BASE="$1"
    local THREAD_COUNT="$2"

    "$SCRIPT_DIR/sfm-cpu.sh" "$BASE" "$THREAD_COUNT"
}

sfm-gpu() {
    local BASE="$1"

    "$SCRIPT_DIR/sfm-gpu.sh" "$BASE"
}

print_help() {
    cat <<EOF
Usage: $(basename "$0") SCRIPT WORKSPACE [ARGS]
rodones script executor 

available scripts:
    sfm-cpu
    sfm-gpu
EOF
}

measure() {
    local CMD="$1"
    local BASE="$2"
    local LOGS="$BASE/logs"
    local ARGS="${*:2}"
    # shellcheck disable=SC2155
    local DATE="$(date +"%FT%H%M%z")"
    local NAME="$CMD""_""$DATE.txt"

    [ "$CMD" = "measure" ] && exit 1

    [ "$CMD" = "--help" ] && print_help && exit 0

    [ -d "$LOGS" ] || mkdir "$LOGS"

    time "$CMD" "$ARGS" | { tee "$LOGS/$NAME"; }
}

measure "$@"
